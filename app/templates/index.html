<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fotowettbewerb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 80px;
        }

        .image-box {
            position: relative;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            overflow: hidden;
            word-wrap: break-word;
        }

        .image-box img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
        }

        .image-box p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            margin-bottom: 0.5rem;
        }

        .vote-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            padding: 6px 10px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 1;
        }
                .vote-button.btn-success {
            background-color: #ff4b5c;  /* Beispielhafte Hintergrundfarbe (rot) */
            color: white;
            border: none;
        }

        /* Umrandung f√ºr das leere Herz */
        .vote-button.btn-outline-success {
            border-color: #ff4b5c; /* Beispielhafte Farbe f√ºr die Umrandung (rot) */
            color: #ff4b5c;
        }

        /* Wenn der Benutzer das Bild "geliked" hat, √§ndert sich das Herz und die Umrandung wird entfernt */
        .vote-button[data-voted="true"] {
            background-color: #ff4b5c;
            color: white;
            border: none;
        }

        .voted {
            opacity: 0.5;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-light fixed-top shadow-sm">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">üñºÔ∏è Fotowettbewerb von LaniLAN und MINGMING</span>
        <a href="{{ url_for('main.login') }}" class="btn btn-outline-secondary btn-sm">Admin Login</a>
    </div>
</nav>

<div class="alert alert-info text-center mb-4">
    Du hast noch <strong>{{ votes_left }}</strong> von 3 Stimmen verf√ºgbar.
</div>
<!-- Galerie -->
<div class="container py-4">
    <div class="row">
        {% for image in images %}
        <div class="col-12 col-sm-6 col-md-4 mb-4">
            <div class="image-box position-relative {% if image.id in voted_ids %}voted{% endif %}" id="image-box-{{ image.id }}">

                <!-- Bild mit Zoom -->
                <img src="{{ url_for('static', filename='uploads/' ~ image.filename) }}"
                     alt="Bild"
                     data-bs-toggle="modal"
                     data-bs-target="#imageModal_{{ image.id }}">

                <!-- Abstimmungsbutton -->
                <button class="btn btn-sm vote-button {% if image.id in voted_ids %}btn-outline-success{% else %}btn-primary{% endif %}"
                        data-image-id="{{ image.id }}"
                        data-voted="{{ 'true' if image.id in voted_ids else 'false' }}">
                    {% if image.id in voted_ids %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                </button>

                <!-- Bildinfos -->
                {% if image.uploader %}
                    <p class="text-muted small mt-2"><strong>{{ image.uploader }}</strong></p>
                {% endif %}
                {% if image.description %}
                    <p>{{ image.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Modal f√ºr dieses Bild -->
        <div class="modal fade" id="imageModal_{{ image.id }}" tabindex="-1" aria-labelledby="modalLabel_{{ image.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <img src="{{ url_for('static', filename='uploads/' ~ image.filename) }}"
                             alt="Zoom-Bild"
                             class="img-fluid mb-3" style="max-height: 80vh; object-fit: contain;">

                        {% if image.uploader %}
                            <h5 class="text-muted">{{ image.uploader }}</h5>
                        {% endif %}
                        {% if image.description %}
                            <p>{{ image.description }}</p>
                        {% endif %}
                    </div>
                    <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-danger px-5" data-bs-dismiss="modal">Schlie√üen</button>
                  </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const maxVotes = 3;
    const voteButtons = document.querySelectorAll('.vote-button');

    // Lade die bereits abgegebenen Stimmen aus dem localStorage
    const votedImages = JSON.parse(localStorage.getItem('votedImages')) || [];
    const voterSessionId = localStorage.getItem('voter_session_id') || uuid.v4(); // Verwende uuid.v4() statt uuidv4()// Generiere eine neue ID, wenn nicht vorhanden
    localStorage.setItem('voter_session_id', voterSessionId);

    // Update der UI basierend auf den abgegebenen Votes
    voteButtons.forEach(button => {
        const imageId = button.dataset.imageId;
        if (votedImages.includes(imageId)) {
            button.classList.add('btn-success');  // Hintergrundfarbe f√ºr ausgef√ºlltes Herz
            button.classList.remove('btn-outline-success');  // Entfernt die Umrandung
            button.dataset.voted = 'true';
            button.innerText = '‚ù§Ô∏è';  // Zeige das ausgef√ºllte Herz an
        }
    });

    // Update der verbleibenden Stimmen
    function updateVotesLeft() {
        const votesLeft = maxVotes - votedImages.length;
        const votesLeftElement = document.querySelector('.alert-info strong');
        if (votesLeftElement) {
            votesLeftElement.textContent = votesLeft;
        }
    }

    updateVotesLeft();  // Update direkt nach dem Laden der Seite

    // Voting-Button-Event-Listener
    voteButtons.forEach(button => {
        button.addEventListener('click', function () {
            const imageId = this.dataset.imageId;

            // Verhindere, dass mehr als 3 Stimmen abgegeben werden
            if (votedImages.length >= maxVotes && !this.dataset.voted) {
                alert("Du hast bereits 3 Stimmen vergeben.");
                return;
            }

            // Wenn der Benutzer bereits abgestimmt hat, entferne die Stimme
            if (this.dataset.voted === 'true') {
                const index = votedImages.indexOf(imageId);
                if (index > -1) {
                    votedImages.splice(index, 1); // Entferne das Bild aus votedImages
                }
                this.classList.remove('btn-success');  // Entferne den Hintergrund
                this.classList.add('btn-outline-success');  // F√ºge die Umrandung hinzu
                this.dataset.voted = 'false';
                this.innerText = 'ü§ç';  // Zeige das leere Herz an
            } else {
                // Wenn noch nicht abgestimmt, f√ºge den Vote hinzu
                if (votedImages.length < maxVotes) {
                    votedImages.push(imageId);
                    this.classList.remove('btn-outline-success');  // Entferne die Umrandung
                    this.classList.add('btn-success');  // F√ºge den Hintergrund hinzu
                    this.dataset.voted = 'true';
                    this.innerText = '‚ù§Ô∏è';  // Zeige das ausgef√ºllte Herz an
                }
            }

            // Speichere die abgestimmten Bilder im localStorage
            localStorage.setItem('votedImages', JSON.stringify(votedImages));

            // Aktualisiere die Anzeige der verbleibenden Stimmen
            updateVotesLeft();

            // Sende die Vote-Informationen an den Server
            fetch(`/vote/${imageId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ voter_session_id: voterSessionId })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert(data.error);
                }
            });
        });
    });
});
</script>
</body>
</html>