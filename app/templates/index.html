<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fotowettbewerb</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 80px;
        }

        .image-box {
            position: relative;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            overflow: hidden;
            word-wrap: break-word;
        }

        .image-box img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
        }

        .image-box p {
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            margin-bottom: 0.5rem;
        }

        .vote-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            padding: 6px 10px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 1;
        }

        .voted {
            opacity: 0.5;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-light fixed-top shadow-sm">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">üñºÔ∏è Fotowettbewerb von LaniLAN und MINGMING</span>
        <a href="{{ url_for('main.login') }}" class="btn btn-outline-secondary btn-sm">Admin Login</a>
    </div>
</nav>

<div class="alert alert-info text-center mb-4">
    Du hast noch <strong>{{ votes_left }}</strong> von 3 Stimmen verf√ºgbar.
</div>
<!-- Galerie -->
<div class="container py-4">
    <div class="row">
        {% for image in images %}
        <div class="col-12 col-sm-6 col-md-4 mb-4">
            <div class="image-box position-relative {% if image.id in voted_ids %}voted{% endif %}">

                <!-- Bild mit Zoom -->
                <img src="{{ url_for('static', filename='uploads/' ~ image.filename) }}"
                     alt="Bild"
                     data-bs-toggle="modal"
                     data-bs-target="#imageModal_{{ image.id }}">

                <!-- Abstimmungsbutton -->
                <button class="btn btn-sm vote-button {% if image.id in voted_ids %}btn-outline-success{% else %}btn-primary{% endif %}"
                        data-image-id="{{ image.id }}"
                        data-voted="{{ 'true' if image.id in voted_ids else 'false' }}">
                    {% if image.id in voted_ids %}üëé{% else %}üëç{% endif %}
                </button>

                <!-- Bildinfos -->
                {% if image.uploader %}
                    <p class="text-muted small mt-2"><strong>{{ image.uploader }}</strong></p>
                {% endif %}
                {% if image.description %}
                    <p>{{ image.description }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Modal f√ºr dieses Bild -->
        <div class="modal fade" id="imageModal_{{ image.id }}" tabindex="-1" aria-labelledby="modalLabel_{{ image.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <img src="{{ url_for('static', filename='uploads/' ~ image.filename) }}"
                             alt="Zoom-Bild"
                             class="img-fluid mb-3" style="max-height: 80vh; object-fit: contain;">

                        {% if image.uploader %}
                            <h5 class="text-muted">{{ image.uploader }}</h5>
                        {% endif %}
                        {% if image.description %}
                            <p>{{ image.description }}</p>
                        {% endif %}
                    </div>
                    <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-danger px-5" data-bs-dismiss="modal">Schlie√üen</button>
                  </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const maxVotes = 3;
        const currentVotes = {{ voted_ids|length }};
        const voteButtons = document.querySelectorAll('.vote-button');

        voteButtons.forEach(button => {
            if (!button.classList.contains('btn-outline-success')) { // Nur wenn noch kein Vote
                button.addEventListener('click', function (e) {
                    if (currentVotes >= maxVotes) {
                        e.preventDefault();
                        alert("Du hast bereits 3 Stimmen vergeben. Entferne eine Stimme oder leb damit, du Penner. üòé");
                    }
                });
            }
        });
    });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const maxVotes = 3;

    function updateVoteDisplay(voteCount) {
        const infoBox = document.querySelector('.alert-info');
        if (infoBox) {
            infoBox.innerHTML = `Du hast noch <strong>${maxVotes - voteCount}</strong> von ${maxVotes} Stimmen verf√ºgbar.`;
        }
    }

    document.querySelectorAll('.vote-button').forEach(button => {
        button.addEventListener('click', function (e) {
            const imageId = this.dataset.imageId;
            const voted = this.dataset.voted === 'true';
            const currentVoteCount = document.querySelectorAll('.vote-button[data-voted="true"]').length;

            if (!voted && currentVoteCount >= maxVotes) {
                alert("Du hast bereits 3 Stimmen vergeben. Entferne eine Stimme oder leb damit, du Penner. üòé");
                return;
            }

            fetch(`/vote/${imageId}`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('btn-primary');
                    this.classList.toggle('btn-outline-success');
                    this.dataset.voted = (!voted).toString();
                    this.innerText = voted ? 'üëç' : 'üëé';
                    this.closest('.image-box').classList.toggle('voted');
                    updateVoteDisplay(data.vote_count);
                }
            });
        });
    });
});
</script>
</body>
</html>