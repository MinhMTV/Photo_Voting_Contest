<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ergebnisse {{ year }} ‚Äì Roulette Finale</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: radial-gradient(circle at 30% 10%, #2a1b45, #0c0a12 60%); color: #f8e8bb; }
    .shell { max-width: 96vw; margin: 0 auto; padding: 20px; }
    .roulette-wrap { background: #151022; border: 1px solid #8f6a2d; border-radius: 16px; padding: 20px; box-shadow: 0 0 40px rgba(255,214,123,.12); }

    .roulette { width: min(78vw, 680px); aspect-ratio: 1 / 1; margin: 0 auto; position: relative; }
    .outer-ring {
      position: absolute; inset: 0; border-radius: 50%;
      background: radial-gradient(circle, #7b5520 58%, #5f3f14 100%);
      box-shadow: inset 0 0 0 6px #c59b43, inset 0 0 25px rgba(0,0,0,.4);
    }
    .track-ring {
      position: absolute; inset: 28px; border-radius: 50%;
      background: radial-gradient(circle, #7d7d7d 0%, #5f5f5f 70%, #4b4b4b 100%);
      box-shadow: inset 0 0 0 2px #9f9f9f;
    }
    .wheel {
      position: absolute; inset: 58px; border-radius: 50%;
      border: 4px solid #d1aa52;
      box-shadow: 0 0 20px rgba(0,0,0,.45), inset 0 0 0 2px #2b1d0b;
      transition: transform 3.8s cubic-bezier(.12,.71,.14,1);
      overflow: hidden;
      background:
        conic-gradient(
          #1f8d3f 0deg 9.729deg,
          #ba2323 9.729deg 19.459deg,
          #111 19.459deg 29.189deg,
          #ba2323 29.189deg 38.918deg,
          #111 38.918deg 48.648deg,
          #ba2323 48.648deg 58.378deg,
          #111 58.378deg 68.108deg,
          #ba2323 68.108deg 77.837deg,
          #111 77.837deg 87.567deg,
          #ba2323 87.567deg 97.297deg,
          #111 97.297deg 107.027deg,
          #ba2323 107.027deg 116.756deg,
          #111 116.756deg 126.486deg,
          #ba2323 126.486deg 136.216deg,
          #111 136.216deg 145.946deg,
          #ba2323 145.946deg 155.675deg,
          #111 155.675deg 165.405deg,
          #ba2323 165.405deg 175.135deg,
          #111 175.135deg 184.865deg,
          #ba2323 184.865deg 194.594deg,
          #111 194.594deg 204.324deg,
          #ba2323 204.324deg 214.054deg,
          #111 214.054deg 223.784deg,
          #ba2323 223.784deg 233.513deg,
          #111 233.513deg 243.243deg,
          #ba2323 243.243deg 252.973deg,
          #111 252.973deg 262.703deg,
          #ba2323 262.703deg 272.432deg,
          #111 272.432deg 282.162deg,
          #ba2323 282.162deg 291.892deg,
          #111 291.892deg 301.622deg,
          #ba2323 301.622deg 311.351deg,
          #111 311.351deg 321.081deg,
          #ba2323 321.081deg 330.811deg,
          #111 330.811deg 340.541deg,
          #ba2323 340.541deg 350.27deg,
          #111 350.27deg 360deg
        );
    }
    .wheel::after {
      content: "";
      position: absolute; inset: 34%; border-radius: 50%;
      background: radial-gradient(circle, #2a2a2a, #101010);
      border: 2px solid #966f2a;
    }

    .numbers-layer { position: absolute; inset: 0; z-index: 7; }
    .num {
      position: absolute;
      color: #ffe6b0; font-size: clamp(10px, 1.1vw, 14px); font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,.8);
      pointer-events: none;
      transform: translate(-50%, -50%);
    }

    .ball {
      width: 14px; height: 14px; border-radius: 50%;
      background: #fff; position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(255,255,255,.95);
      z-index: 4;
    }
    .pointer {
      width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent;
      border-top: 24px solid #f8d483; margin: 0 auto 8px; filter: drop-shadow(0 2px 1px rgba(0,0,0,.45));
    }

    .slot { min-height: 120px; background: #0f0b19; border: 1px dashed #8f6a2d; border-radius: 12px; padding: 12px; }
    .reveal-card img { width: 100%; max-height: 280px; object-fit: cover; border-radius: 12px; }
    #winner-stickers { position: fixed; inset: 0; pointer-events: none; z-index: 3; }
    #winner-stickers img { position: absolute; width: 68px; opacity: .85; animation: drift 6s ease-in-out infinite; }
    @keyframes drift { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-16px) } }
  </style>
</head>
<body>
<div id="winner-stickers"></div>
<div class="shell">
  <h1 class="text-center mb-3">üé∞ Roulette Finale {{ year }}</h1>
  <p class="text-center text-warning-emphasis mb-4">Reihenfolge: <strong>5 ‚Üí 4 ‚Üí 3 ‚Üí 2 ‚Üí 1</strong>. Dr√ºcke jedes Mal auf <strong>‚ÄûKugel setzen‚Äú</strong>.</p>

  <div class="roulette-wrap">
    <div class="row g-4 align-items-center">
      <div class="col-12 col-lg-7 text-center">
        <div class="pointer"></div>
        <div class="roulette" id="roulette">
          <div class="outer-ring"></div>
          <div class="track-ring"></div>
          <div class="wheel" id="wheel"><div class="numbers-layer" id="numbersLayer"></div></div>
          <div class="ball" id="ball"></div>
        </div>
        <div class="mt-3">
          <div class="badge text-bg-dark border border-warning-subtle">N√§chster Platz: <span id="nextPlace">5</span></div>
        </div>
        <button id="spinBtn" class="btn btn-warning mt-3">Kugel setzen</button>
      </div>
      <div class="col-12 col-lg-5">
        <div class="slot" id="revealList">
          <div class="text-muted">Noch keine Platzierungen aufgedeckt.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="top10Section" class="mt-4 d-none">
    <h3 class="mb-3">üèÅ Gesamt√ºbersicht Top 10</h3>
    <div class="row g-3">
      {% for image in top_10_images %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card bg-dark text-light border-warning-subtle h-100">
          <img src="{{ url_for('main.media_year', year=year, filename=image.filename) }}" class="card-img-top" style="height:140px;object-fit:cover" alt="{{ image.uploader }}">
          <div class="card-body p-2">
            <div class="small">#{{ loop.index }} ¬∑ <strong>{{ image.uploader or 'Anonymous' }}</strong></div>
            <div class="small text-warning">Chips: {{ image.vote_points or 0 }} ¬∑ Stimmen: {{ image.vote_count or 0 }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="modal fade" id="winnerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-warning">
      <div class="modal-header">
        <h5 class="modal-title" id="winnerTitle">Platzierung</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body reveal-card" id="winnerBody"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const top5 = {{ top_images_json|tojson }};
let step = 5;
let idx = 4;
let spinning = false;
let wheelAngle = 0;
const wheel = document.getElementById('wheel');
const ball = document.getElementById('ball');
const numbersLayer = document.getElementById('numbersLayer');
const btn = document.getElementById('spinBtn');
const nextPlace = document.getElementById('nextPlace');
const revealList = document.getElementById('revealList');
const top10Section = document.getElementById('top10Section');
const winnerModal = new bootstrap.Modal(document.getElementById('winnerModal'));

const rouletteOrder = [0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26];
const redNumbers = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);

function colorForNumber(n) {
  if (n === 0) return '#1f8d3f';
  return redNumbers.has(n) ? '#ba2323' : '#111';
}

function applyWheelColors() {
  const seg = 360 / rouletteOrder.length;
  const parts = rouletteOrder.map((n, i) => `${colorForNumber(n)} ${(i * seg).toFixed(3)}deg ${((i + 1) * seg).toFixed(3)}deg`);
  wheel.style.background = `conic-gradient(${parts.join(',')})`;
}

function angleForNumber(n) {
  const idx = rouletteOrder.indexOf(Number(n));
  const seg = 360 / rouletteOrder.length;
  // Mittelpunkt des Segments (nicht Segmentkante)
  return (idx * seg) + (seg / 2) - 90;
}

function buildNumbers() {
  const size = document.getElementById('roulette').clientWidth;
  const c = size / 2;
  const radius = size * 0.33;
  numbersLayer.innerHTML = '';

  rouletteOrder.forEach((n) => {
    const angle = angleForNumber(n);
    const rad = angle * Math.PI / 180;
    const x = c + (Math.cos(rad) * radius);
    const y = c + (Math.sin(rad) * radius);

    const el = document.createElement('div');
    el.className = 'num';
    el.textContent = String(n);
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    numbersLayer.appendChild(el);
  });
}

function setBallPolar(angleDeg, radiusPx) {
  const rad = angleDeg * Math.PI / 180;
  const x = Math.cos(rad) * radiusPx;
  const y = Math.sin(rad) * radiusPx;
  ball.style.left = `calc(50% + ${x}px)`;
  ball.style.top = `calc(50% + ${y}px)`;
}

function normalizeDeg(d) {
  return ((d % 360) + 360) % 360;
}

function animateBallToNumber(targetNumber, wheelAngleDeg, durationMs) {
  return new Promise(resolve => {
    const start = performance.now();
    const laps = 6;
    const baseTarget = angleForNumber(targetNumber);
    // Nummern sitzen auf dem (mitdrehenden) Wheel -> Kugelziel muss Wheel-Rotation ber√ºcksichtigen
    const targetAngle = normalizeDeg(baseTarget + normalizeDeg(wheelAngleDeg));
    const size = document.getElementById('roulette').clientWidth;
    const startRadius = size * 0.40;
    const endRadius = size * 0.31;

    function frame(now) {
      const t = Math.min(1, (now - start) / durationMs);
      const ease = 1 - Math.pow(1 - t, 3);
      const angle = -90 + (laps * 360 + (targetAngle + 90)) * ease;
      const radius = startRadius + (endRadius - startRadius) * ease;
      setBallPolar(angle, radius);
      if (t < 1) requestAnimationFrame(frame);
      else {
        setBallPolar(targetAngle, endRadius);
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

function appendReveal(place, item) {
  if (!item) return;
  if (revealList.querySelector('.text-muted')) revealList.innerHTML = '';
  const el = document.createElement('div');
  el.className = 'mb-2 p-2 rounded border border-warning-subtle bg-black';
  el.innerHTML = `<strong>Platz ${place}:</strong> ${item.uploader || 'Anonymous'} ¬∑ Chips ${item.vote_points || 0} ¬∑ Stimmen ${item.vote_count || 0}`;
  revealList.appendChild(el);
}

applyWheelColors();
buildNumbers();
setBallPolar(-90, document.getElementById('roulette').clientWidth * 0.40);
window.addEventListener('resize', () => {
  buildNumbers();
});

btn.addEventListener('click', async () => {
  if (spinning || step < 1) return;
  if (!top5.length || idx < 0 || !top5[idx]) {
    btn.disabled = true;
    btn.textContent = 'Keine ausreichenden Daten';
    return;
  }

  spinning = true;
  btn.disabled = true;

  const targetNumber = step; // 5,4,3,2,1
  wheelAngle += 1800 + Math.floor(Math.random() * 240);
  wheel.style.transform = `rotate(${wheelAngle}deg)`;

  await animateBallToNumber(targetNumber, wheelAngle, 3800);

  const item = top5[idx];
  appendReveal(step, item);

  document.getElementById('winnerTitle').textContent = `üéâ Platz ${step} (Feld ${targetNumber})`;
  document.getElementById('winnerBody').innerHTML = `
    <img src="/media/{{ year }}/${item.filename}" alt="winner">
    <div class="mt-2"><strong>${item.uploader || 'Anonymous'}</strong></div>
    <div class="small text-warning">Chips: ${item.vote_points || 0} ¬∑ Stimmen: ${item.vote_count || 0}</div>
    <div class="small">${item.description || ''}</div>`;
  winnerModal.show();

  idx -= 1;
  step -= 1;
  nextPlace.textContent = step >= 1 ? String(step) : 'Fertig';

  spinning = false;
  if (step < 1) {
    btn.disabled = true;
    btn.textContent = 'Finale abgeschlossen';
    top10Section.classList.remove('d-none');
  } else {
    btn.disabled = false;
    // Kugel bleibt auf dem getroffenen Feld liegen bis zum n√§chsten Spin
  }
});

fetch('/api/stickers/{{ year }}').then(r => r.json()).then(stickers => {
  if (!stickers || !stickers.length) return;
  const layer = document.getElementById('winner-stickers');
  const total = Math.min(14, stickers.length);
  for (let i = 0; i < total; i++) {
    const img = document.createElement('img');
    img.src = `/sticker/{{ year }}/${stickers[Math.floor(Math.random() * stickers.length)]}`;
    img.style.left = `${Math.random() * 95}%`;
    img.style.top = `${Math.random() * 92}%`;
    img.style.animationDelay = `${Math.random() * 4}s`;
    layer.appendChild(img);
  }
}).catch(() => {});
</script>
</body>
</html>
