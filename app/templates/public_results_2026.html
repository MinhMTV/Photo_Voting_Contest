<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ergebnisse {{ year }} – Roulette Finale</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body { margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      background-image:
        radial-gradient(circle farthest-corner at 50% 40%, #527c14, #243a0a);
      background-size: auto;
      background-attachment: fixed;
      color: #f8e8bb;
      user-select: none;
      touch-action: pan-y;
      -webkit-tap-highlight-color: transparent;
    }
    .shell { max-width: 96vw; margin: 0 auto; padding: 20px; }
    .roulette-wrap { background: rgba(10,10,10,.18); border: 1px solid #8f6a2d; border-radius: 16px; padding: 20px; box-shadow: 2px 10px 30px rgba(0,0,0,.4); }

    .roulette { width: min(82vw, 760px); aspect-ratio: 1 / 1; margin: 0 auto; position: relative; overflow: visible; }
    .outer-ring {
      position: absolute; inset: 0; border-radius: 50%;
      background: radial-gradient(circle at 35% 30%, #9a4f35 0%, #6a2f20 45%, #431b14 75%, #2a100d 100%);
      box-shadow: inset 0 0 0 5px #d9bb77, inset 0 0 0 14px #5e2619, inset 0 0 35px rgba(0,0,0,.45);
    }
    .track-ring {
      position: absolute; inset: 30px; border-radius: 50%;
      background: radial-gradient(circle, #8d8d8d 0%, #646464 65%, #4f4f4f 100%);
      box-shadow: inset 0 0 0 2px #b8b8b8, inset 0 0 10px rgba(0,0,0,.35);
    }
    .wheel {
      position: absolute; inset: 58px; border-radius: 50%;
      border: 4px solid #d1aa52;
      box-shadow: 0 0 20px rgba(0,0,0,.45), inset 0 0 0 2px #2b1d0b;
      transition: transform 13.2s cubic-bezier(.12,.71,.14,1);
      overflow: hidden;
      background: #111;
    }
    .field-ring {
      position: absolute;
      inset: 22%;
      border-radius: 50%;
      border: 2px solid #d1aa52;
      box-shadow: inset 0 0 0 1px #2b1d0b;
      z-index: 3;
    }
    .wheel::after {
      content: "";
      position: absolute; inset: 36%; border-radius: 50%;
      background: radial-gradient(circle, #6b2f1f, #3d180f 70%, #2d120c);
      border: 2px solid #966f2a;
      z-index: 2;
    }

    .thumbs-layer { position: absolute; inset: 0; z-index: 7; }
    .thumb {
      position: absolute;
      width: clamp(30px, 4.6vw, 52px);
      height: clamp(22px, 3.4vw, 38px);
      border-radius: 4px;
      object-fit: cover;
      border: 1.5px solid #f1d28a;
      box-shadow: 0 1px 3px rgba(0,0,0,.55);
      transform: translate(-50%, -50%);
      pointer-events: none;
      background:#000;
    }
    .thumb-num {
      position: absolute;
      transform: translate(-50%, -50%);
      font-size: clamp(10px, 1.1vw, 14px);
      font-weight: 700;
      color: #ffe7b0;
      text-shadow: 0 1px 2px rgba(0,0,0,.9);
      z-index: 9;
      pointer-events: none;
    }
    .legend-list {
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:8px;
      max-height:none;
      overflow:visible;
    }
    .legend-item { display:flex; align-items:center; gap:6px; padding:6px 6px; border:1px solid rgba(255,255,255,.12); border-radius:8px; background:rgba(0,0,0,.2); min-width:0; }
    .legend-num { min-width:30px; text-align:center; border:1px solid #b98f3e; border-radius:6px; color:#ffd98e; font-weight:700; font-size:.85rem; }
    .legend-name { flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:.85rem; }

    .ball {
      width: 26px; height: 26px; border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #fff, #e8e8e8 60%, #cfcfcf);
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 14px rgba(255,255,255,.95);
      z-index: 8;
    }
    .pointer {
      width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent;
      border-top: 24px solid #f8d483; margin: 0 auto 8px; filter: drop-shadow(0 2px 1px rgba(0,0,0,.45));
    }

    .slot { min-height: 120px; background: #0f0b19; border: 1px dashed #8f6a2d; border-radius: 12px; padding: 12px; }
    .reveal-card { text-align:center; position:relative; overflow:hidden; }
    .reveal-card img { width: min(92%, 420px); max-height: 300px; object-fit: cover; border-radius: 14px; border:2px solid #f3cf87; box-shadow:0 0 20px rgba(255,212,120,.35); }

    #winnerModal .modal-content {
      background: radial-gradient(circle at 50% 20%, #2d1235, #120817 70%);
      border: 2px solid #ffcf70 !important;
      box-shadow: 0 0 25px rgba(255, 76, 166, .55), 0 0 60px rgba(255, 207, 112, .25);
      overflow: hidden;
      text-align: center;
    }
    #winnerModal .modal-header { justify-content: center; border-bottom: 1px solid rgba(255,255,255,.12); }
    #winnerModal .modal-title {
      font-weight: 900;
      letter-spacing: .8px;
      text-transform: uppercase;
      color: #ffd98e;
      text-shadow: 0 0 8px rgba(255,217,142,.65), 0 0 20px rgba(255,70,155,.35);
      animation: titleFlicker 900ms ease-in-out infinite;
    }
    #winnerModal .btn-close { position:absolute; right:14px; top:14px; }

    .party-wrap {
      position: absolute; inset: 0; pointer-events: none; z-index: 2;
      background:
        radial-gradient(circle at 15% 20%, rgba(255,70,155,.24), transparent 28%),
        radial-gradient(circle at 82% 24%, rgba(71,196,255,.22), transparent 30%),
        radial-gradient(circle at 50% 78%, rgba(255,208,89,.2), transparent 34%);
      animation: partyGlow 1.6s ease-in-out infinite;
    }
    .party-beam {
      position:absolute; width:4px; height:120%; top:-10%; left:50%; transform-origin:50% 55%;
      background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,92,171,.65), rgba(255,255,255,0));
      filter: blur(0.5px);
      animation: beamSpin 3.2s linear infinite;
    }
    .party-beam.b2 { animation-duration: 2.6s; background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(89,206,255,.6), rgba(255,255,255,0)); }
    .party-beam.b3 { animation-duration: 3.8s; background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,220,120,.62), rgba(255,255,255,0)); }

    .win-name { margin-top:10px; font-size: clamp(1.15rem,2.4vw,1.6rem); font-weight: 900; color:#fff0cf; text-shadow: 0 0 12px rgba(255,112,188,.42); }
    .win-meta { font-size:1rem; color:#ffd98e; font-weight:700; margin-top:4px; }
    .win-desc { margin-top:8px; font-size:.97rem; color:#f4e7ff; opacity:.95; }

    @keyframes titleFlicker { 0%,100%{opacity:1} 50%{opacity:.82} }
    @keyframes partyGlow { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.28)} }
    @keyframes beamSpin { from{transform:translateX(-50%) rotate(0deg)} to{transform:translateX(-50%) rotate(360deg)} }
    #winner-stickers { position: fixed; inset: 0; pointer-events: none; z-index: 3; }
    #winner-stickers img { position: absolute; width: 68px; opacity: .85; animation: drift 6s ease-in-out infinite; }
    @keyframes drift { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-16px) } }

    .casino-fx {
      position: absolute; inset: -6%; pointer-events: none; z-index: 14; display: block;
    }
    .casino-fx.active { display: block; }

    .neon-ring {
      position: absolute; inset: 2%; border-radius: 50%;
      border: 6px solid rgba(255, 41, 117, .9);
      box-shadow:
        0 0 20px rgba(255,41,117,.8),
        0 0 40px rgba(255,41,117,.65),
        0 0 70px rgba(30,180,255,.5),
        inset 0 0 20px rgba(255,41,117,.6);
      animation: neonPulse 900ms linear infinite;
    }

    .bulb-ring {
      position: absolute; inset: 0; border-radius: 50%;
      background: repeating-conic-gradient(
        rgba(255,220,120,.0) 0deg 5deg,
        rgba(255,220,120,1) 5deg 8deg,
        rgba(255,220,120,.0) 8deg 10deg
      );
      filter: drop-shadow(0 0 4px rgba(255,220,120,.9)) drop-shadow(0 0 12px rgba(255,220,120,.7));
      animation: chase 1.1s linear infinite;
      mask: radial-gradient(circle, transparent 62%, #000 63%, #000 70%, transparent 71%);
      -webkit-mask: radial-gradient(circle, transparent 62%, #000 63%, #000 70%, transparent 71%);
    }

    .arrow {
      position: absolute; width: 0; height: 0;
      border-left: 16px solid transparent; border-right: 16px solid transparent;
      border-top: 28px solid #ff2a7f;
      filter: drop-shadow(0 0 8px rgba(255,42,127,.95));
      animation: arrowBlink 500ms steps(2,end) infinite;
    }
    .arrow.a1 { left: 50%; top: -2%; transform: translateX(-50%); }
    .arrow.a2 { right: 8%; top: 20%; transform: rotate(70deg); }
    .arrow.a3 { left: 8%; top: 20%; transform: rotate(-70deg); }

    .sparkles {
      position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 15;
    }
    .spark {
      position: absolute; width: 10px; height: 10px; border-radius: 50%;
      background: radial-gradient(circle, #fff, #ffd36a);
      animation: sparkle 1100ms ease-out forwards;
    }

    @keyframes neonPulse {
      0%,100% { filter: brightness(1); }
      50% { filter: brightness(1.55); }
    }
    @keyframes chase { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes arrowBlink { 0%,100% { opacity:.35; } 50% { opacity:1; } }
    @keyframes sparkle {
      from { transform: translateY(0) scale(1); opacity: 1; }
      to { transform: translateY(-58px) scale(0.12); opacity: 0; }
    }

    #global-party {
      position: fixed; inset: 0; pointer-events: none; z-index: 25; overflow: hidden; display:none;
    }
    #global-party.active { display:block; }
    .party-orb {
      position: absolute;
      width: clamp(16px, 2.4vw, 34px);
      height: clamp(16px, 2.4vw, 34px);
      border-radius: 50%;
      filter: blur(.2px) drop-shadow(0 0 10px rgba(255,255,255,.55));
      opacity: .85;
      animation: orbitFloat linear infinite;
    }
    .party-orb.pink { background: radial-gradient(circle, #ffd0ec, #ff2e96); }
    .party-orb.blue { background: radial-gradient(circle, #c7f2ff, #2ab7ff); }
    .party-orb.gold { background: radial-gradient(circle, #fff2bf, #ffbf2a); }
    @keyframes orbitFloat {
      0% { transform: translate3d(0,0,0) scale(1); }
      25% { transform: translate3d(30px,-22px,0) scale(1.12); }
      50% { transform: translate3d(-18px,-48px,0) scale(.92); }
      75% { transform: translate3d(-34px,16px,0) scale(1.08); }
      100% { transform: translate3d(0,0,0) scale(1); }
    }

    .money {
      position:absolute;
      width: clamp(26px, 3.2vw, 44px);
      height: clamp(14px, 1.8vw, 24px);
      border-radius: 3px;
      background: linear-gradient(135deg, #b8ff9e, #5bcf64 55%, #2f8e3d);
      box-shadow: 0 0 10px rgba(126,255,148,.55);
      animation: moneyFall linear infinite;
      opacity:.88;
    }
    @keyframes moneyFall {
      0% { transform: translateY(-15vh) rotate(0deg); opacity:.0; }
      10% { opacity:.92; }
      100% { transform: translateY(115vh) rotate(540deg); opacity:.15; }
    }

    .firework {
      position:absolute; width:4px; height:4px; border-radius:50%;
      background:#fff; box-shadow:0 0 8px rgba(255,255,255,.95);
      animation: firework 1.1s ease-out forwards;
    }
    @keyframes firework {
      from { transform: translate(0,0) scale(1); opacity:1; }
      to { transform: translate(var(--dx), var(--dy)) scale(.2); opacity:0; }
    }
  </style>
</head>
<body>
<div id="winner-stickers"></div>
<div id="global-party"></div>
<div class="shell">
  <h1 class="text-center mb-3">🎰 Roulette Finale {{ year }}</h1>
  <p class="text-center text-warning-emphasis mb-4">Reihenfolge: <strong>5 → 4 → 3 → 2 → 1</strong>. Drücke jedes Mal auf <strong>„Kugel setzen“</strong>.</p>

  <div class="roulette-wrap">
    <div class="row g-3 align-items-start">
      <div class="col-12 col-lg-7 text-center">
        <div class="pointer"></div>
        <div class="roulette" id="roulette">
          <div class="outer-ring"></div>
          <div class="track-ring"></div>
          <div class="wheel" id="wheel"><div class="field-ring" id="fieldRing"></div><div class="thumbs-layer" id="thumbsLayer"></div></div>
          <div class="ball" id="ball"></div>
          <div class="casino-fx" id="casinoFx">
            <div class="neon-ring"></div>
            <div class="bulb-ring"></div>
            <div class="arrow a1"></div>
            <div class="arrow a2"></div>
            <div class="arrow a3"></div>
            <div class="sparkles" id="sparkles"></div>
          </div>
        </div>
        <div class="mt-3">
          <div class="badge text-bg-dark border border-warning-subtle">Nächster Platz: <span id="nextPlace">5</span></div>
        </div>
        <button id="spinBtn" class="btn btn-warning mt-3">Kugel setzen</button>
      </div>
      <div class="col-12 col-lg-5 d-flex flex-column justify-content-start">
        <div class="slot mb-2" id="numberLegend">
          <div class="fw-semibold mb-2">🎯 Zahlen-Legende</div>
          <div class="legend-list" id="legendList"></div>
        </div>
        <div class="slot" id="revealList">
          <div class="text-muted">Noch keine Platzierungen aufgedeckt.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="top10Section" class="mt-4 d-none">
    <h3 class="mb-3">🏁 Gesamtübersicht Top 10</h3>
    <div class="row g-3">
      {% for image in top_10_images %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card bg-dark text-light border-warning-subtle h-100">
          <img src="{{ url_for('main.media_year', year=year, filename=image.filename) }}" class="card-img-top" style="height:140px;object-fit:cover" alt="{{ image.uploader }}">
          <div class="card-body p-2">
            <div class="small">#{{ loop.index }} · <strong>{{ image.uploader or 'Anonymous' }}</strong></div>
            <div class="small text-warning">Chips: {{ image.vote_points or 0 }} · Stimmen: {{ image.vote_count or 0 }}</div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<div class="modal fade" id="winnerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-light border-warning">
      <div class="modal-header">
        <h5 class="modal-title" id="winnerTitle">Platzierung</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body reveal-card" id="winnerBody"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const top5 = {{ top_images_json|tojson }};
const rankingImages = {{ ranking_images_json|tojson }};
let step = Math.min(5, top5.length || 0);
let idx = step - 1;
let spinning = false;
let wheelAngle = 0;
const wheel = document.getElementById('wheel');
const ball = document.getElementById('ball');
const casinoFx = document.getElementById('casinoFx');
const sparkles = document.getElementById('sparkles');
const thumbsLayer = document.getElementById('thumbsLayer');
const fieldRing = document.getElementById('fieldRing');
const btn = document.getElementById('spinBtn');
const nextPlace = document.getElementById('nextPlace');
const revealList = document.getElementById('revealList');
const legendList = document.getElementById('legendList');
const top10Section = document.getElementById('top10Section');
const winnerModal = new bootstrap.Modal(document.getElementById('winnerModal'));
document.getElementById('winnerModal').addEventListener('hidden.bs.modal', stopCasinoCelebrate);

const participants = (rankingImages || []).filter(x => x && x.filename);

function shuffledNumbers0to36() {
  const arr = Array.from({ length: 37 }, (_, i) => i); // 0..36
  for (let i = arr.length - 1; i > 1; i--) {
    const j = 1 + Math.floor(Math.random() * i);
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  // 0 bleibt fix auf Position 0
  return arr;
}

const numPool = shuffledNumbers0to36();
const participantNumberById = new Map();
participants.forEach((p, i) => {
  participantNumberById.set(Number(p.id), numPool[i % 37]);
});
if (!participants.length || step === 0) {
  btn.disabled = true;
  btn.textContent = 'Keine Teilnehmer';
}

function colorForIndex(i) {
  const p = participants[i];
  const n = p ? participantNumberById.get(Number(p.id)) : null;
  if (n === 0) return '#1f8d3f'; // 0 immer grün
  return i % 2 === 0 ? '#111' : '#ba2323';
}

function segmentCount() {
  return Math.max(1, participants.length);
}

function applyWheelColors() {
  const count = segmentCount();
  const seg = 360 / count;
  const parts = Array.from({length: count}, (_, i) => `${colorForIndex(i)} ${(i * seg).toFixed(3)}deg ${((i + 1) * seg).toFixed(3)}deg`);
  wheel.style.background = `conic-gradient(${parts.join(',')})`;
  fieldRing.style.background = `conic-gradient(${parts.join(',')})`;
}

function angleForIndex(i) {
  const count = segmentCount();
  const seg = 360 / count;
  return (i * seg) + (seg / 2) - 90;
}

function findParticipantIndexByImageId(imageId) {
  const idx = participants.findIndex(p => Number(p.id) === Number(imageId));
  return idx >= 0 ? idx : 0;
}

function buildLegend() {
  if (!legendList) return;
  legendList.innerHTML = '';
  const rows = participants.map(p => ({
    id: Number(p.id),
    name: p.uploader || 'Anonymous',
    n: participantNumberById.get(Number(p.id)) || 0
  })).sort((a,b) => a.n - b.n);

  rows.forEach(r => {
    const row = document.createElement('div');
    row.className = 'legend-item';
    row.innerHTML = `<span class="legend-num">${r.n}</span><span class="legend-name">${r.name}</span>`;
    legendList.appendChild(row);
  });
}

function buildThumbs() {
  const wheelSize = wheel.clientWidth;
  const c = wheelSize / 2;
  const thumbRadius = wheelSize * 0.47;  const count = segmentCount();
  const segArc = (2 * Math.PI * thumbRadius) / count;
  const fieldW = Math.max(30, Math.min(68, segArc * 0.98));
  const fieldH = Math.max(18, Math.min(40, fieldW * 0.62));

  thumbsLayer.innerHTML = '';
  participants.forEach((p, i) => {
    const angle = angleForIndex(i);
    const rad = angle * Math.PI / 180;

    const tx = c + (Math.cos(rad) * thumbRadius);
    const ty = c + (Math.sin(rad) * thumbRadius);

    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = `/media/{{ year }}/${p.filename}`;
    img.alt = p.uploader || 'Teilnehmer';
    img.style.left = `${tx}px`;
    img.style.top = `${ty}px`;
    img.style.width = `${fieldW}px`;
    img.style.height = `${fieldH}px`;
    img.style.transform = `translate(-50%, -50%) rotate(${angle + 90}deg)`;
    thumbsLayer.appendChild(img);

    const n = participantNumberById.get(Number(p.id)) || 0;
    const nr = thumbRadius - (fieldH * 0.72);
    const nx = c + (Math.cos(rad) * nr);
    const ny = c + (Math.sin(rad) * nr);
    const numEl = document.createElement('div');
    numEl.className = 'thumb-num';
    numEl.textContent = String(n);
    numEl.style.left = `${nx}px`;
    numEl.style.top = `${ny}px`;
    thumbsLayer.appendChild(numEl);
  });
}

function setBallPolar(angleDeg, radiusPx) {
  const rad = angleDeg * Math.PI / 180;
  const x = Math.cos(rad) * radiusPx;
  const y = Math.sin(rad) * radiusPx;
  ball.style.left = `calc(50% + ${x}px)`;
  ball.style.top = `calc(50% + ${y}px)`;
}

function normalizeDeg(d) {
  return ((d % 360) + 360) % 360;
}

function animateBallToIndex(targetIndex, wheelAngleDeg, durationMs) {
  return new Promise(resolve => {
    const start = performance.now();
    const laps = 9;
    const baseTarget = angleForIndex(targetIndex);
    // Nummern sitzen auf dem (mitdrehenden) Wheel -> Kugelziel muss Wheel-Rotation berücksichtigen
    const targetAngle = normalizeDeg(baseTarget + normalizeDeg(wheelAngleDeg));
    const size = document.getElementById('roulette').clientWidth;
    const startRadius = size * 0.44; // startet im grauen Außenbereich
    const endRadius = size * 0.25;   // landet auf inneren Feldern

    function frame(now) {
      const t = Math.min(1, (now - start) / durationMs);
      // Smooth deceleration toward target (no bounce)
      const angleEase = 1 - Math.pow(1 - t, 6.5);
      const radialEase = 1 - Math.pow(1 - t, 3.2);

      const angle = -90 + (laps * 360 + (targetAngle + 90)) * angleEase;
      const radius = startRadius + (endRadius - startRadius) * radialEase;
      setBallPolar(angle, radius);
      if (t < 1) requestAnimationFrame(frame);
      else {
        setBallPolar(targetAngle, endRadius);
        resolve();
      }
    }
    requestAnimationFrame(frame);
  });
}

function appendReveal(place, item) {
  if (!item) return;
  if (revealList.querySelector('.text-muted')) revealList.innerHTML = '';
  const el = document.createElement('div');
  el.className = 'mb-2 p-2 rounded border border-warning-subtle bg-black';
  const n = participantNumberById.get(Number(item.id)) || '-';
  el.innerHTML = `<strong>Platz ${place}:</strong> #${n} ${item.uploader || 'Anonymous'} · Chips ${item.vote_points || 0}`;
  revealList.appendChild(el);
}

let sparkleTimer = null;
let fireworkTimer = null;

function burstSparkles() {
  if (!sparkles) return;
  sparkles.innerHTML = '';
  for (let i = 0; i < 42; i++) {
    const s = document.createElement('div');
    s.className = 'spark';
    s.style.left = `${5 + Math.random() * 90}%`;
    s.style.top = `${25 + Math.random() * 65}%`;
    s.style.animationDelay = `${Math.random() * 180}ms`;
    sparkles.appendChild(s);
  }
}

function launchFireworkBurst() {
  const gp = document.getElementById('global-party');
  if (!gp) return;
  const cx = 10 + Math.random() * 80;
  const cy = 10 + Math.random() * 50;
  for (let i = 0; i < 26; i++) {
    const f = document.createElement('div');
    f.className = 'firework';
    const ang = (Math.PI * 2 * i) / 26;
    const dist = 30 + Math.random() * 120;
    f.style.left = `${cx}%`;
    f.style.top = `${cy}%`;
    f.style.setProperty('--dx', `${Math.cos(ang) * dist}px`);
    f.style.setProperty('--dy', `${Math.sin(ang) * dist}px`);
    gp.appendChild(f);
    setTimeout(() => f.remove(), 1200);
  }
}

function casinoCelebrate() {
  if (casinoFx) casinoFx.classList.add('active');
  const gp = document.getElementById('global-party');
  if (gp) gp.classList.add('active');

  burstSparkles();
  if (sparkleTimer) clearInterval(sparkleTimer);
  sparkleTimer = setInterval(burstSparkles, 700);

  if (fireworkTimer) clearInterval(fireworkTimer);
  launchFireworkBurst();
  fireworkTimer = setInterval(launchFireworkBurst, 1200);
}

function stopCasinoCelebrate() {
  if (sparkleTimer) {
    clearInterval(sparkleTimer);
    sparkleTimer = null;
  }
  if (fireworkTimer) {
    clearInterval(fireworkTimer);
    fireworkTimer = null;
  }
  if (sparkles) sparkles.innerHTML = '';
  if (casinoFx) casinoFx.classList.remove('active');
  const gp = document.getElementById('global-party');
  if (gp) gp.classList.remove('active');
}

function initGlobalParty() {
  const gp = document.getElementById('global-party');
  if (!gp) return;
  gp.innerHTML = '';
  const colors = ['pink','blue','gold'];
  for (let i = 0; i < 36; i++) {
    const o = document.createElement('div');
    o.className = `party-orb ${colors[i % colors.length]}`;
    o.style.left = `${Math.random() * 100}%`;
    o.style.top = `${Math.random() * 100}%`;
    o.style.animationDuration = `${6 + Math.random() * 8}s`;
    o.style.animationDelay = `${Math.random() * 4}s`;
    gp.appendChild(o);
  }
  for (let i = 0; i < 28; i++) {
    const m = document.createElement('div');
    m.className = 'money';
    m.style.left = `${Math.random() * 100}%`;
    m.style.animationDuration = `${4 + Math.random() * 5}s`;
    m.style.animationDelay = `${Math.random() * 3}s`;
    gp.appendChild(m);
  }
}

applyWheelColors();
buildThumbs();
buildLegend();
initGlobalParty();
nextPlace.textContent = step > 0 ? String(step) : '–';
setBallPolar(-90, document.getElementById('roulette').clientWidth * 0.44);
window.addEventListener('resize', () => {
  buildThumbs();
});

btn.addEventListener('click', async () => {
  if (spinning || step < 1) return;
  if (!top5.length || idx < 0 || !top5[idx]) {
    btn.disabled = true;
    btn.textContent = 'Keine ausreichenden Daten';
    return;
  }

  spinning = true;
  btn.disabled = true;

  const item = top5[idx];
  const targetIndex = findParticipantIndexByImageId(item.id);
  wheelAngle -= 2100 + Math.floor(Math.random() * 280);
  wheel.style.transform = `rotate(${wheelAngle}deg)`;

  await animateBallToIndex(targetIndex, wheelAngle, 13200);

  appendReveal(step, item);

  const n = participantNumberById.get(Number(item.id)) || '-';
  document.getElementById('winnerTitle').textContent = `🎉 Platz ${step}`;
  document.getElementById('winnerBody').innerHTML = `
    <div class="party-wrap">
      <div class="party-beam"></div>
      <div class="party-beam b2"></div>
      <div class="party-beam b3"></div>
    </div>
    <img src="/media/{{ year }}/${item.filename}" alt="winner">
    <div class="win-name">#${n} ${item.uploader || 'Anonymous'}</div>
    <div class="win-meta">🪙 Chips: ${item.vote_points || 0}</div>
    <div class="win-desc">${item.description || ''}</div>`;
  casinoCelebrate();
  winnerModal.show();

  idx -= 1;
  step -= 1;
  nextPlace.textContent = step >= 1 ? String(step) : 'Fertig';

  spinning = false;
  if (step < 1) {
    btn.disabled = true;
    btn.textContent = 'Finale abgeschlossen';
    top10Section.classList.remove('d-none');
  } else {
    btn.disabled = false;
    // Kugel bleibt auf dem getroffenen Feld liegen bis zum nächsten Spin
  }
});

fetch('/api/stickers/{{ year }}').then(r => r.json()).then(stickers => {
  if (!stickers || !stickers.length) return;
  const layer = document.getElementById('winner-stickers');
  const total = Math.min(14, stickers.length);
  for (let i = 0; i < total; i++) {
    const img = document.createElement('img');
    img.src = `/sticker/{{ year }}/${stickers[Math.floor(Math.random() * stickers.length)]}`;
    img.style.left = `${Math.random() * 95}%`;
    img.style.top = `${Math.random() * 92}%`;
    img.style.animationDelay = `${Math.random() * 4}s`;
    layer.appendChild(img);
  }
}).catch(() => {});
</script>
</body>
</html>




