<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Photo Voting {{ year }} - Casino Night</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body{background:radial-gradient(circle at top,#241044,#0a0a0f 60%);color:#f4e4b8;min-height:100vh}
        #casino-stickers{position:fixed;inset:0;pointer-events:none;z-index:5}
        #casino-stickers img{position:absolute;width:64px;opacity:.9;filter:drop-shadow(0 0 8px rgba(255,215,0,.35));animation:floaty 6s ease-in-out infinite}
        @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
        .topbar{backdrop-filter: blur(8px); background: rgba(20,10,35,.75); border-bottom:1px solid #a77b2f}
        .brand{font-weight:700;color:#ffd166}
        .card-casino{background:linear-gradient(180deg,#1a1230,#120b24);border:1px solid #7f5a1e;border-radius:14px;box-shadow:0 0 24px rgba(255,209,102,.15)}
        .img-wrap img{width:100%;height:260px;object-fit:cover;border-radius:10px}
        .btn-gold{background:#d4a63a;border:0;color:#1f1300}
        .btn-gold:hover{background:#e5b94f}
        .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:#301d57;color:#ffe8a7;border:1px solid #8d6b2f}
        .slot-title{font-size:1.1rem;color:#ffdf8e}
        .countdown{font-weight:700;color:#ffdf8e;text-shadow:0 0 8px rgba(255,215,120,.25)}
    </style>
</head>
<body>
<nav class="navbar topbar sticky-top">
    <div class="container-fluid px-3">
        <span class="brand">CASINO Photo Voting Contest {{ year }}</span>
        <div class="d-flex gap-2">
            {% for y in legacy_years %}
            <a href="{{ url_for('main.public_results_year', year=y) }}" class="btn btn-outline-warning btn-sm">Ergebnisse {{ y }}</a>
            {% endfor %}
            <a href="{{ url_for('main.duel_year', year=year) }}" class="btn btn-outline-danger btn-sm">‚öîÔ∏è Duell</a>
            <a href="{{ url_for('main.public_results_year', year=year) }}" class="btn btn-gold btn-sm">{{ year }} Ergebnisse</a>
            <a href="{{ url_for('main.login') }}" class="btn btn-outline-light btn-sm">Admin</a>
        </div>
    </div>
</nav>
<div id="casino-stickers"></div>

<div class="container py-3">
    <div class="text-center mb-3 d-flex flex-column gap-2 align-items-center">
        <span class="chip">Du hast noch <strong>{{ votes_left }}</strong> / 3 Stimmen</span>
        <span class="chip countdown" id="countdown" data-end="{{ voting_end_at }}">Countdown l√§dt...</span>
    </div>
    <div class="row g-3">
        {% for image in images %}
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card-casino p-3 h-100">
                <div class="img-wrap mb-2">
                    <img src="{{ url_for('main.media_year', year=year, filename=image.filename) }}" alt="Bild">
                </div>
                <div class="slot-title">{{ image.uploader or 'Anonymous Player' }}</div>
                <p class="small text-warning-emphasis">{{ image.description or '' }}</p>
                <button class="btn btn-sm vote-button {% if image.id in voted_ids %}btn-warning{% else %}btn-outline-warning{% endif %}" data-image-id="{{ image.id }}" data-voted="{{ 'true' if image.id in voted_ids else 'false' }}">{% if image.id in voted_ids %}üí• Gepusht{% else %}üî• Pushen{% endif %}</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const maxVotes = 3;
    const voterSessionId = localStorage.getItem('voter_session_id') || uuid.v4();
    localStorage.setItem('voter_session_id', voterSessionId);
    const buttons = document.querySelectorAll('.vote-button');

    fetch('/api/stickers/{{ year }}').then(r => r.json()).then(stickers => {
        const layer = document.getElementById('casino-stickers');
        const total = Math.min(14, stickers.length);
        for (let i = 0; i < total; i++) {
            const img = document.createElement('img');
            const sticker = stickers[Math.floor(Math.random() * stickers.length)];
            img.src = `/sticker/{{ year }}/${sticker}`;
            img.style.left = `${Math.random() * 95}%`;
            img.style.top = `${Math.random() * 90}%`;
            img.style.animationDelay = `${Math.random() * 3}s`;
            layer.appendChild(img);
        }
    }).catch(() => {});

    const countdownEl = document.getElementById('countdown');
    const endAt = new Date(countdownEl.dataset.end);
    function tickCountdown(){
        const now = new Date();
        const diff = endAt - now;
        if(diff <= 0){
            countdownEl.textContent = 'Voting beendet';
            buttons.forEach(b => b.disabled = true);
            return;
        }
        const d = Math.floor(diff / (1000*60*60*24));
        const h = Math.floor((diff / (1000*60*60)) % 24);
        const m = Math.floor((diff / (1000*60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        countdownEl.textContent = `Voting endet in ${d}d ${h}h ${m}m ${s}s`;
    }
    setInterval(tickCountdown, 1000); tickCountdown();

    buttons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const imageId = btn.dataset.imageId;
            const res = await fetch(`/vote/${imageId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({voter_session_id: voterSessionId, contest_year: {{ year }}})
            });
            const data = await res.json();
            if (!data.success) return alert(data.error || 'Fehler');

            const isVoted = btn.dataset.voted === 'true';
            btn.dataset.voted = isVoted ? 'false' : 'true';
            btn.classList.toggle('btn-warning');
            btn.classList.toggle('btn-outline-warning');
            btn.textContent = isVoted ? 'üî• Pushen' : 'üí• Gepusht';

            const left = Math.max(0, maxVotes - data.vote_count);
            document.querySelector('.chip').innerHTML = `Du hast noch <strong>${left}</strong> / 3 Stimmen`;
        });
    });
});
</script>
</body>
</html>
