<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Photo Voting {{ year }} - Casino Night</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body{background:radial-gradient(circle at top,#241044,#0a0a0f 60%);color:#f4e4b8;min-height:100vh}
        #casino-stickers{position:fixed;inset:0;pointer-events:none;z-index:5}
        #casino-stickers img{position:absolute;width:64px;opacity:.9;filter:drop-shadow(0 0 8px rgba(255,215,0,.35));animation:floaty 6s ease-in-out infinite}
        @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
        .topbar{backdrop-filter: blur(8px); background: rgba(20,10,35,.75); border-bottom:1px solid #a77b2f}
        .brand{font-weight:700;color:#ffd166}
        .card-casino{background:linear-gradient(180deg,#1a1230,#120b24);border:1px solid #7f5a1e;border-radius:14px;box-shadow:0 0 24px rgba(255,209,102,.15)}
        .img-wrap{position:relative;cursor:pointer}
        .img-wrap img{width:100%;height:260px;object-fit:cover;border-radius:10px;border:2px solid transparent}
        .img-wrap.voted img{border-color:#7dff9d;box-shadow:0 0 14px rgba(125,255,157,.45)}
        .placed-chip{position:absolute;left:50%;bottom:6px;transform:translateX(-50%);display:none;align-items:flex-end;justify-content:center;min-width:60px;min-height:44px;pointer-events:none}
        .placed-chip.show{display:flex}
        .placed-chip img{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(255,255,255,.35))}
        .placed-chip.allin img{margin:0 -10px}
        .btn-gold{background:#d4a63a;border:0;color:#1f1300}
        .btn-gold:hover{background:#e5b94f}
        .chip{display:inline-block;padding:4px 10px;border-radius:999px;background:#301d57;color:#ffe8a7;border:1px solid #8d6b2f}
        .slot-title{font-size:1.1rem;color:#ffdf8e}
        .countdown{font-weight:700;color:#ffdf8e;text-shadow:0 0 8px rgba(255,215,120,.25)}
        .reaction-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
        .reaction-btn{border:1px solid #8d6b2f;background:#221538;color:#ffd98e;border-radius:999px;padding:4px 10px;font-size:.8rem}
        .reaction-btn.active{background:#d4a63a;color:#1f1300;border-color:#d4a63a}
        .chip-select{width:48px;height:48px;border-radius:50%;font-weight:800;padding:0;display:inline-flex;align-items:center;justify-content:center;background:#1a102e}
        .chip-select img{width:36px;height:36px;object-fit:contain;pointer-events:none}
        .chip-select.allin{width:auto;padding:0 10px;border-radius:999px}
        .chip-select.used{opacity:.35;filter:grayscale(.9)}
    </style>
</head>
<body>
<nav class="navbar topbar sticky-top">
    <div class="container-fluid px-3">
        <span class="brand">CASINO Photo Voting Contest {{ year }}</span>
        <div class="d-flex gap-2">
            <a href="{{ url_for('main.archive') }}" class="btn btn-outline-warning btn-sm">ðŸ—‚ï¸ Archiv</a>
            <a href="{{ url_for('main.duel_year', year=year) }}" class="btn btn-outline-danger btn-sm">âš”ï¸ Duell</a>
            <a href="{{ url_for('main.public_results_year', year=year) }}" class="btn btn-gold btn-sm">{{ year }} Ergebnisse</a>
            <a href="{{ url_for('main.login') }}" class="btn btn-outline-light btn-sm">Admin</a>
        </div>
    </div>
</nav>
<div id="casino-stickers"></div>

<div class="container py-3">
    <div class="text-center mb-3 d-flex flex-column gap-2 align-items-center">
        <span class="chip" id="votesChip">Du hast noch <strong>{{ votes_left }}</strong> / 5 Chips</span>
        <div class="chip" id="chipPicker">Chips:
          <button type="button" class="reaction-btn chip-select active" data-chip="100"><img src="{{ url_for('static', filename='chips/chip_100.png') }}" alt="100"></button>
          <button type="button" class="reaction-btn chip-select" data-chip="50"><img src="{{ url_for('static', filename='chips/chip_50.png') }}" alt="50"></button>
          <button type="button" class="reaction-btn chip-select" data-chip="25"><img src="{{ url_for('static', filename='chips/chip_25.png') }}" alt="25"></button>
          <button type="button" class="reaction-btn chip-select" data-chip="5"><img src="{{ url_for('static', filename='chips/chip_5.png') }}" alt="5"></button>
          <button type="button" class="reaction-btn chip-select allin" data-chip="all-in">ALL-IN</button>
          <button type="button" class="reaction-btn" id="resetVotesBtn">Reset</button>
        </div>
        <span class="chip countdown" id="countdown" data-end="{{ voting_end_at }}">Countdown lÃ¤dt...</span>
    </div>
    <div class="row g-3">
        {% for image in images %}
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card-casino p-3 h-100">
                <div class="img-wrap mb-2 {% if image.id in voted_ids %}voted{% endif %}" data-image-id="{{ image.id }}">
                    <img src="{{ url_for('main.media_year', year=year, filename=image.filename) }}" alt="Bild">
                    {% set ub = user_bets.get(image.id|string) %}
                    <div class="placed-chip {% if ub %}show{% endif %} {% if ub and (ub.chip_label in ['all-in','allin']) %}allin{% endif %}" data-chip-on-image="{{ ub.chip_label if ub else '' }}"></div>
                </div>
                <div class="slot-title">{{ image.uploader or 'Anonymous Player' }}</div>
                <p class="small text-warning-emphasis">{{ image.description or '' }}</p>
                <div class="small text-info">Tippe aufs Bild, um den gewählten Chip zu setzen.</div>
                <div class="reaction-row">
                    <button class="reaction-btn {% if 'hype' in (user_reactions.get(image.id|string, [])) %}active{% endif %}" data-image-id="{{ image.id }}" data-reaction="hype">ðŸš€ Hype</button>
                    <button class="reaction-btn {% if 'creative' in (user_reactions.get(image.id|string, [])) %}active{% endif %}" data-image-id="{{ image.id }}" data-reaction="creative">ðŸŽ¨ Kreativ</button>
                    <button class="reaction-btn {% if 'funny' in (user_reactions.get(image.id|string, [])) %}active{% endif %}" data-image-id="{{ image.id }}" data-reaction="funny">ðŸ˜‚ Funny</button>
                    <button class="reaction-btn {% if 'underrated' in (user_reactions.get(image.id|string, [])) %}active{% endif %}" data-image-id="{{ image.id }}" data-reaction="underrated">ðŸ’Ž Underrated</button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const maxVotes = 5;
    const voterSessionId = localStorage.getItem('voter_session_id') || uuid.v4();
    localStorage.setItem('voter_session_id', voterSessionId);
    document.cookie = `voter_session_id=${encodeURIComponent(voterSessionId)}; path=/; max-age=31536000; samesite=lax`;

    const imageCards = document.querySelectorAll('.img-wrap[data-image-id]');
    const reactionButtons = document.querySelectorAll('.reaction-btn:not(.chip-select)');
    const votesChip = document.getElementById('votesChip');
    const chipButtons = document.querySelectorAll('.chip-select');
    const resetVotesBtn = document.getElementById('resetVotesBtn');
    let selectedChip = '100';
    const chipImageMap = {
        '5': "{{ url_for('static', filename='chips/chip_5.png') }}",
        '25': "{{ url_for('static', filename='chips/chip_25.png') }}",
        '50': "{{ url_for('static', filename='chips/chip_50.png') }}",
        '100': "{{ url_for('static', filename='chips/chip_100.png') }}"
    };
    const usedChips = new Set(Array.from(document.querySelectorAll('.placed-chip.show')).map(el => (el.dataset.chipOnImage || '').toLowerCase()).filter(Boolean));

    function renderPlacedChip(chipEl, chipLabel) {
        chipEl.innerHTML = '';
        chipEl.classList.remove('allin');
        chipEl.dataset.chipOnImage = chipLabel || '';
        if (!chipLabel) return;

        if (chipLabel === 'all-in' || chipLabel === 'allin') {
            chipEl.classList.add('allin');
            ['5','25','50','100'].forEach(c => {
                const im = document.createElement('img');
                im.src = chipImageMap[c];
                im.alt = c;
                chipEl.appendChild(im);
            });
            return;
        }

        const img = document.createElement('img');
        img.src = chipImageMap[chipLabel] || chipImageMap['5'];
        img.alt = chipLabel;
        chipEl.appendChild(img);
    }

    function selectChip(chip) {
        const btn = Array.from(chipButtons).find(b => b.dataset.chip === chip);
        if (!btn) return;
        if (usedChips.has(chip) && chip !== selectedChip) return;
        chipButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedChip = chip;
        refreshChipButtons();
    }

    function selectNextAvailableChip() {
        const order = ['100', '50', '25', '5'];
        const next = order.find(c => !usedChips.has(c));
        if (next) selectChip(next);
    }

    function refreshChipButtons() {
        chipButtons.forEach(btn => {
            const chip = btn.dataset.chip;
            const isUsed = usedChips.has(chip) && chip !== selectedChip;
            btn.classList.toggle('used', isUsed);
        });
    }

    chipButtons.forEach(btn => {
        btn.addEventListener('click', () => selectChip(btn.dataset.chip));
    });

    document.querySelectorAll('.placed-chip').forEach(el => {
        const chip = (el.dataset.chipOnImage || '').toLowerCase();
        if (chip) renderPlacedChip(el, chip);
    });
    refreshChipButtons();

    resetVotesBtn.addEventListener('click', async () => {
        if (!confirm('Alle gesetzten Chips zurücksetzen?')) return;
        const res = await fetch(`/api/reset-votes/{{ year }}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({voter_session_id: voterSessionId})
        });
        const data = await res.json();
        if (!data.success) return alert(data.error || 'Reset fehlgeschlagen');

        usedChips.clear();
        imageCards.forEach(card => {
            card.classList.remove('voted');
            const chipEl = card.querySelector('.placed-chip');
            chipEl.classList.remove('show');
            renderPlacedChip(chipEl, '');
        });
        votesChip.innerHTML = `Du hast noch <strong>5</strong> / 5 Chips`;
        selectChip('100');
    });

    fetch('/api/stickers/{{ year }}').then(r => r.json()).then(stickers => {
        const layer = document.getElementById('casino-stickers');
        const total = Math.min(14, stickers.length);
        for (let i = 0; i < total; i++) {
            const img = document.createElement('img');
            const sticker = stickers[Math.floor(Math.random() * stickers.length)];
            img.src = `/sticker/{{ year }}/${sticker}`;
            img.style.left = `${Math.random() * 95}%`;
            img.style.top = `${Math.random() * 90}%`;
            img.style.animationDelay = `${Math.random() * 3}s`;
            layer.appendChild(img);
        }
    }).catch(() => {});

    async function syncVoteState() {
        try {
            const res = await fetch(`/api/voter-state/{{ year }}?voter_session_id=${encodeURIComponent(voterSessionId)}`);
            const state = await res.json();
            const votedSet = new Set(state.voted_ids || []);
            imageCards.forEach(card => {
                const imageId = Number(card.dataset.imageId);
                card.classList.toggle('voted', votedSet.has(imageId));
            });

            const left = Math.max(0, state.votes_left ?? (maxVotes - (state.vote_count || 0)));
            votesChip.innerHTML = `Du hast noch <strong>${left}</strong> / 5 Chips`;
        } catch (_) {}
    }

    syncVoteState();

    const countdownEl = document.getElementById('countdown');
    const endAt = new Date(countdownEl.dataset.end);
    function tickCountdown(){
        const now = new Date();
        const diff = endAt - now;
        if(diff <= 0){
            countdownEl.textContent = 'Voting beendet';
            imageCards.forEach(c => c.style.pointerEvents = 'none');
            reactionButtons.forEach(b => b.disabled = true);
            chipButtons.forEach(b => b.disabled = true);
            return;
        }
        const d = Math.floor(diff / (1000*60*60*24));
        const h = Math.floor((diff / (1000*60*60)) % 24);
        const m = Math.floor((diff / (1000*60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        countdownEl.textContent = `Voting endet in ${d}d ${h}h ${m}m ${s}s`;
    }
    setInterval(tickCountdown, 1000); tickCountdown();

    imageCards.forEach(card => {
        card.addEventListener('click', async () => {
            const imageId = card.dataset.imageId;
            const chipEl = card.querySelector('.placed-chip');
            const previousChip = (chipEl.dataset.chipOnImage || '').toLowerCase();

            const res = await fetch(`/vote/${imageId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({voter_session_id: voterSessionId, contest_year: {{ year }}, chip_label: selectedChip})
            });
            const data = await res.json();
            if (!data.success) return alert(data.error || 'Fehler');

            const cardWasVoted = card.classList.contains('voted');
            if (cardWasVoted && previousChip === selectedChip) {
                card.classList.remove('voted');
                chipEl.classList.remove('show');
                renderPlacedChip(chipEl, '');

                if (selectedChip === 'all-in') {
                    ['5','25','50','100','all-in'].forEach(c => usedChips.delete(c));
                } else {
                    usedChips.delete(selectedChip);
                }
            } else {
                if (previousChip && previousChip !== selectedChip) {
                    if (previousChip === 'all-in') {
                        ['5','25','50','100','all-in'].forEach(c => usedChips.delete(c));
                    } else {
                        usedChips.delete(previousChip);
                    }
                }

                card.classList.add('voted');
                chipEl.classList.add('show');
                renderPlacedChip(chipEl, selectedChip);

                if (selectedChip === 'all-in') {
                    ['5','25','50','100','all-in'].forEach(c => usedChips.add(c));
                } else {
                    usedChips.add(selectedChip);
                }
            }

            refreshChipButtons();
            if (selectedChip !== 'all-in') selectNextAvailableChip();
            const left = Math.max(0, maxVotes - data.vote_count);
            votesChip.innerHTML = `Du hast noch <strong>${left}</strong> / 5 Chips`;
        });
    });

    reactionButtons.forEach(btn => {
        btn.addEventListener('click', async () => {
            const imageId = btn.dataset.imageId;
            const reactionType = btn.dataset.reaction;
            const res = await fetch(`/react/${imageId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    voter_session_id: voterSessionId,
                    contest_year: {{ year }},
                    reaction_type: reactionType
                })
            });
            const data = await res.json();
            if (!data.success) return alert(data.error || 'Fehler');
            btn.classList.toggle('active', data.active);
        });
    });
});
</script>
</body>
</html>

