<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neon Royale Slot Duel {{ year }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--bg:#09050f;--pink:#ff2ea6;--blue:#21d4fd;--gold:#ffb347;--gold2:#ffd166}
    body{margin:0;min-height:100vh;background:radial-gradient(circle at 20% 10%,rgba(255,46,166,.25),transparent 35%),radial-gradient(circle at 80% 20%,rgba(33,212,253,.2),transparent 30%),radial-gradient(circle at 50% 100%,rgba(255,179,71,.2),transparent 35%),var(--bg);color:#ffecc3;font-family:"Segoe UI",system-ui,sans-serif}
    .page{max-width:860px;margin:0 auto;padding:14px 12px 26px}
    .topline{text-align:center;color:#f0d8a8;letter-spacing:.08em;font-weight:700;opacity:.9;text-shadow:0 0 10px rgba(255,179,71,.5)}
    .brand{text-align:center;font-size:2.6rem;font-weight:900;margin:4px 0 10px;background:linear-gradient(90deg,#ffd166 0%,#ff2ea6 45%,#21d4fd 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 0 20px rgba(255,46,166,.35),0 0 24px rgba(33,212,253,.35)}

    .machine-wrap{position:relative;padding-right:72px}
    .slot-machine{border-radius:28px;padding:14px;background:linear-gradient(180deg,#44205f 0%,#220f33 100%);border:3px solid #ff9f1c;box-shadow:0 0 0 2px rgba(255,209,102,.35) inset,0 0 30px rgba(255,179,71,.45),0 12px 40px rgba(0,0,0,.5)}
    .bulb-row{height:16px;border-radius:999px;background:#3d183d;border:1px solid rgba(255,196,102,.55);padding:2px 6px;display:flex;gap:4px;justify-content:space-between;margin-bottom:10px}
    .bulb{width:7px;height:7px;border-radius:50%;background:#ffef9f;box-shadow:0 0 8px #ffef9f,0 0 16px #ff6bcb;animation:blink 1.2s infinite alternate}
    .bulb:nth-child(2n){animation-delay:.3s}.bulb:nth-child(3n){animation-delay:.6s}@keyframes blink{from{opacity:.45}to{opacity:1}}

    .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;min-height:560px}
    .reel{background:linear-gradient(180deg,#140a22,#090612);border:2px solid rgba(255,209,102,.8);border-radius:14px;padding:10px;box-shadow:inset 0 0 24px rgba(255,160,80,.15);display:flex;flex-direction:column}
    .reel.voted{border-color:#57ff89;box-shadow:0 0 18px rgba(87,255,137,.8), inset 0 0 24px rgba(255,160,80,.15)}
    .reel-window{border-radius:10px;overflow:hidden;border:1px solid rgba(255,179,71,.45);background:#000;margin-bottom:8px}
    .reel-window img{width:100%;height:300px;object-fit:cover;display:block;transition:transform .18s linear,filter .18s linear}
    .title{font-weight:800;color:#ffd47f;font-size:1rem;line-height:1.1;min-height:38px}
    .meta{font-size:.82rem;color:#f3d49d;opacity:.85;min-height:46px;margin-top:3px}
    .vote-btn{width:100%;border:0;border-radius:10px;padding:10px;margin-top:auto;font-weight:900;letter-spacing:.03em;color:#fff;background:linear-gradient(180deg,#ff4d7d,#cc103f);box-shadow:0 2px 0 #7f0a28,0 0 16px rgba(255,77,125,.45)}
    .vote-btn.voted{background:linear-gradient(180deg,#59ff92,#1ca84f);box-shadow:0 2px 0 #0b6d2f,0 0 16px rgba(89,255,146,.65)}

    .lever-box{position:absolute;right:4px;top:170px;display:flex;flex-direction:column;align-items:center;gap:10px}
    .knob{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff8cb,#ff9f1c 70%);border:2px solid #ffd166;box-shadow:0 0 14px rgba(255,179,71,.8)}
    .lever{width:16px;height:150px;border-radius:10px;cursor:pointer;transform-origin:top center;background:linear-gradient(180deg,#ffe08a,#f39c12);box-shadow:0 0 12px rgba(255,179,71,.75);transition:transform .22s ease}
    .lever::after{content:"";display:block;width:26px;height:26px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff6cd,#ff9f1c 70%);border:2px solid #ffd166;position:relative;left:-5px;top:128px}

    .spinning .lever{transform:rotate(30deg)}
    .spinning .reel-window img{filter:blur(2px) saturate(1.25);transform:translateY(-8px)}
    .feedback{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#1f7a3a;color:#fff;padding:8px 14px;border-radius:999px;font-weight:700;box-shadow:0 0 14px rgba(89,255,146,.6);opacity:0;pointer-events:none;transition:opacity .25s}
    .feedback.show{opacity:1}

    .nav-actions{display:flex;justify-content:flex-start;margin-top:10px}
    .btn-outline-neon{border:1px solid rgba(255,209,102,.75);color:#ffd98f;background:rgba(0,0,0,.25)}

    @media (max-width:920px){.page{max-width:680px}.machine-wrap{padding-right:0}.lever-box{position:static;flex-direction:row;justify-content:center;margin-top:12px}.lever{height:80px}.lever::after{top:58px}.reel-window img{height:180px}.reels{min-height:auto}}
  </style>
</head>
<body>
  <div class="feedback" id="voteFeedback">✅ Vote gespeichert</div>
  <div class="page">
    <div class="topline">Las Vegas × Monte Carlo</div>
    <div class="brand">Neon Royale</div>

    <div class="machine-wrap" id="machineWrap">
      <div class="slot-machine">
        <div class="bulb-row">{% for _ in range(42) %}<span class="bulb"></span>{% endfor %}</div>
        <div class="reels" id="reels">
          {% for c in candidates %}
          <div class="reel">
            <div class="reel-window"><img src="{{ url_for('main.media_year', year=year, filename=c.filename) }}" alt="{{ c.uploader }}"></div>
            <div class="title">{{ c.uploader or 'Unbekannt' }}</div>
            <div class="meta">{{ c.description or '' }}</div>
            <button class="vote-btn duel-pick" data-id="{{ c.id }}">Vote</button>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="lever-box"><div class="knob"></div><div class="lever" id="lever"></div></div>
    </div>

    <div class="nav-actions"><a href="{{ url_for('main.contest_year', year=year) }}" class="btn btn-sm btn-outline-neon">Zurück</a></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/uuid@8.3.2/dist/umd/uuid.min.js"></script>
<script>
const voterSessionId = localStorage.getItem('voter_session_id') || uuid.v4();
localStorage.setItem('voter_session_id', voterSessionId);
document.cookie = `voter_session_id=${encodeURIComponent(voterSessionId)}; path=/; max-age=31536000; samesite=lax`;

const machine = document.getElementById('machineWrap');
const lever = document.getElementById('lever');
const reels = [...document.querySelectorAll('.reel')];
const feedback = document.getElementById('voteFeedback');
let spinning = false;

function applyCandidateToReel(reel, c){
  reel.classList.remove('voted');
  const b = reel.querySelector('.duel-pick');
  b.classList.remove('voted');
  b.textContent = 'Vote';
  reel.querySelector('img').src = `/media/{{ year }}/${c.filename}`;
  reel.querySelector('.title').textContent = c.uploader || 'Unbekannt';
  reel.querySelector('.meta').textContent = c.description || '';
  b.dataset.id = c.id;
}

async function spinMachine(){
  if (spinning) return;
  spinning = true;
  machine.classList.add('spinning');

  const res = await fetch(`/api/duel-spin/{{ year }}`);
  const data = await res.json();
  if (!data.success) {
    spinning = false;
    machine.classList.remove('spinning');
    alert(data.error || 'Spin fehlgeschlagen');
    return;
  }

  const pool = data.candidates;
  const timers = reels.map((reel, i) => setInterval(() => {
    const r = pool[Math.floor(Math.random() * pool.length)];
    applyCandidateToReel(reel, r);
  }, 85 + (i * 25)));

  reels.forEach((reel, i) => {
    setTimeout(() => {
      clearInterval(timers[i]);
      applyCandidateToReel(reel, data.candidates[i]);
      if (i === reels.length - 1) {
        spinning = false;
        machine.classList.remove('spinning');
      }
    }, 950 + (i * 360));
  });
}

lever.addEventListener('click', spinMachine);

document.body.addEventListener('click', async (e) => {
  const btn = e.target.closest('.duel-pick');
  if (!btn || spinning) return;

  const reel = btn.closest('.reel');
  const imageId = btn.dataset.id;
  const res = await fetch(`/vote/${imageId}`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({voter_session_id: voterSessionId, contest_year: {{ year }}})
  });
  const data = await res.json();
  if (!data.success) return alert(data.error || 'Fehler beim Vote');

  reel.classList.add('voted');
  btn.classList.add('voted');
  btn.textContent = 'Gevotet';
  feedback.classList.add('show');
  setTimeout(() => feedback.classList.remove('show'), 900);

  setTimeout(() => spinMachine(), 650);
});
</script>
</body>
</html>